---
title: TrenchBoot Anti Evil Maid - Phase 2
abstract: 'TrenchBoot Anti Evil Maid project for Qubes OS is progressing. With
           the addition of TPM 2.0 support, Anti Evil Maid gains much higher
           adoption and possibilities than ever before.'
cover: /covers/trenchboot-logo.png
author: michal.zygowski
layout: post
published: true
date: 2023-09-27
archives: "2023"

tags:
  - coreboot
  - QubesOS
  - TrenchBoot
  - GRUB2
  - Xen
  - Hypervisor
categories:
  - Firmware
  - Bootloader
  - Hypervisor
  - OS Dev
  - Security


---

# Introduction

If you haven't read the previous [TrenchBoot AEM blog
post](https://blog.3mdeb.com/2023/2023-01-31-trenchboot-aem-for-qubesos/) or
our [project plan](https://docs.dasharo.com/projects/trenchboot-aem-v2/) yet,
it may be a good lecture to catch up on what the TrenchBoot AEM project is
about. This post will guide you through the most recent progress and show a
demo of TrenchBoot AEM in action, plus installation steps.

## What's new in TrenchBoot AEM?

The main focus of this phase was to get the TPM 2.0 working with Qubes OS AEM
scripts on the DRTM boot flow in TrenchBoot (GRUB and Xen). Let's go through
each of the tasks quickly.

### Implement parallel CPU cores bring-up for DRTM launch

It is not strictly related to TPM 2.0 support, but after phase 1, it occurred
to be necessary to clean up the code for CPU bring-up in Xen. As the phase 1
was just a Proof of Concept, some inefficiencies in the code happened to land.
The most significant change in this [pull
request](https://github.com/TrenchBoot/xen/pull/1/files) is the parallel
bring-up of the CPUs, in opposite to the previous implementation, which caused
the CPUs to wait in a queue. It had to be fixed because if an interrupt
occurred during the wait time, it could pose a severe threat to security.

### Support for TPM 2.0 module in Xen

With the introduction of TPM 2.0 support, Xen also required changes that would
perform the dom0 kernel and initrd measurements properly. As a quick reminder,
TPM 1.2 and TPM 2.0 communication protocols to extend the PCRs with software
measurements differ slightly. Also, TPM 2.0 uses stronger hash algorithms than
TPM 1.2, like SHA256, which had to be added to Xen. Changes are outlined in
this [pull request](https://github.com/TrenchBoot/xen/pull/3/files).

### Support for TPM 2.0 event log in Xen

Similarly to the previous task, besides the communication protocol difference,
the event log, where the information about measurements is stored, differs
between TPM 1.2 and TPM 2.0. As a next step after measuring the dom0 kernel
and initrd to TPM 2.0 PCRs, we had to record the hashes in the event log in
TPM 2.0 compliant format. The event log is a very important chunk of
information, which lets one confirm what is measured and if the TPM PCRs
actually match the values that have been extended (basically an attestation).
Changes to Xen are outlined in this [pull
request](https://github.com/TrenchBoot/xen/pull/4/files).

### Integrate TPM 2.0 software stack into Qubes OS Dom0

This is where the changes outside of Qubes OS sources end. A first
prerequisite to making the AEM scripts talk to TPM2 was to include the
appropriate tool stack. Up till now, AEM implementation only had the TPM 1.2
software and utilities included. This [pull
request](https://github.com/QubesOS/qubes-antievilmaid/pull/46/files) outlines
TPM 2.0 software, which has been included in Qubes OS initrd and will be used
by AEM scripts later.

### Extend the AEM scripts to detect TPM version on the platform

Before TPM 2.0 could be used, we had to prepare routines that detect the TPM
version and temporarily refuse to use AEM if TPM 2.0 is detected. It was just
a stepping stone to avoid issuing unsupported commands to TPM 2.0 using TPM
1.2 software until proper TPM 2.0 support is added. Changes are outlined in
this [pull
request](https://github.com/QubesOS/qubes-antievilmaid/pull/45/files)

### Extend the AEM scripts to use appropriate software stack for TPM 2.0

Now that we have the TPM version detection in place, we could start
implementing the equivalent AEM functionality for TPM 2.0. The scripts have
been generalized and split into separate "libraries" for TPM 1.2 and TPM 2.0
with a unified, higher-level API, abstracting the TPM version in the main AEM
logic. First, we have isolated the TPM 1.2 support and prepared the
higher-level API as a grounding for the incoming TPM 2.0 support in this [pull
request](https://github.com/QubesOS/qubes-antievilmaid/pull/47/files). Then,
we proceeded with adding the actual TPM 2.0 support in this [pull
request](https://github.com/QubesOS/qubes-antievilmaid/pull/42/files). Besides
the changes in the main AEM repository, there were various other extra
repositories, which were responsible for features like Qubes OS disk migration
to another machine (i.e., to detect multiple different TPMs on different
devices when AEM is used). Those also needed TPM 2.0 equivalents to maintain
the functionality. The changes are outlined in the following pull requests:

* [qubes-tpm-extra](https://github.com/QubesOS/qubes-tpm-extra/pull/7/files)
* [qubes-trousers-changer](https://github.com/QubesOS/qubes-trousers-changer/pull/6/files)

### Test TPM 2.0 support on Intel hardware with legacy boot mode and Update Qubes OS AEM documentation

Of course, the changes had to be validated using Intel-based platforms capable
of doing DRTM with TPM 2.0. As a reminder, older Intel platforms like 3rd
generation Ivy Bridge could only support TPM 1.2 with Intel TXT (Intel's DRTM
technology), so for testing purposes, we had to use newer hardware. It also
goes without saying that the test should be conducted on the machine with TPM
1.2 to check if the new changes didn't break anything.

As a cherry on top, the Qubes OS AEM documentation was extended and improved
to reflect the current state of AEM support, now covering TPM 2.0.
Unfortunately, it still supports legacy boot mode only. But support for UEFI
boot mode will also be added in the future.

TBD link to documentation change.

## Demo

To summarize our efforts, a short demo has been prepared showcasing the newest
Qubes OS AEM installation and utilization on a relatively modern Intel
platform with TPM 2.0. Enjoy watching!

TBD link to yt

## Summary

It has been quite a long journey implementing the TPM 2.0 support, yet much
more awaits us. We bet you are eager to hear more about TrenchBoot AEM and
can't wait to see the AMD DRTM or UEFI boot mode support coming to Qubes OS.
It will be the first time AEM is launched on an AMD platform, which certainly
stirs up some hype. If you like what we do, please consider supporting us:

* if you can hack a bit, your testing results will be invaluable,
* spread the word about us and the project on social media,
* any other way you see fit.

If you think we can help in improving the security of your firmware or you are
looking for someone who can boost your product by leveraging advanced features
of used hardware platform, feel free to
[book a call with us](https://calendly.com/3mdeb/consulting-remote-meeting) or
drop us email to `contact<at>3mdeb<dot>com`. If you are interested in similar
content, feel free to
[sign up to our newsletter](https://newsletter.3mdeb.com/subscription/PW6XnCeK6)
