---
title: What is IOMMU and how it can be used?
abstract: 'Introductory blog post on how IOMMU works.
          In this article you can read what IOMMU is
          and find out if its use may be beneficial for you.'
cover: /covers/IOMMU.png
author: marek.kasiewicz
layout: post
published: true
date: 2020-12-08
archives: "2020"

tags:
  - Firmware
  - IOMMU
  - Security
categories:
  - Firmware
  - Security

---

## Introduction

The I/O memory management unit (IOMMU) is a type of memory management unit (MMU)
that connects a Direct Memory Access (DMA) capable expansion bus to the main memory.
It extends the system architecture by adding support for the virtualization of
memory addresses used by peripheral devices. Additionally, it provides memory
isolation and protection by enabling system software to control which areas of
physical memory an I/O device may access. It also helps filter and remap interrupts
from peripheral devices. 

Advantages of IOMMU usage:

  - One single contiguous virtual memory region can be mapped to multiple non-contiguous
  physical memory regions. IOMMU can make a non-contiguous memory region appear
  contiguous to a device (scatter/gather). Scatter/gather optimizes streaming DMA
  performance for the I/O device.
  - Memory isolation and protection: device can only access memory regions that are
  mapped for it. Hence faulty and/or malicious devices can't corrupt memory.
  - Memory isolation allows safe device assignment to a virtual machine without
  compromising host and other guest OSes.
  - IOMMU enables 32-bit DMA capable devices to access to > 4GB memory.
  - Support hardware interrupt remapping. It extends limited hardware interrupts
  to software interrupts. Primary uses are the interrupt isolation and translation
  between interrupt domains (E.g. ioapic vs x2apic on x86)

Disadvantages:

  - Latency in dynamic DMA mapping, translation overhead penalty.
  - Host software must maintain in-memory data structures for use by the IOMMU

## In hardware

IOMMUâ€™s architecture is designed to accommodate a variety of system topologies.
There can be multiple IOMMUs located at a variety of places in the system fabric.
It can be placed at bridges inside one bus or at bridges between busses of the
same or different types.In modern systems, it is commonly integrated with the
PCIe root complex. It connects to the PCIe bus from downstream and to the system
bus ( E.g. infinity fabric) from upstream. One example topology is shown below.

![Example Platform Architecture](/img/iommu.png) 

## In software

The IOMMU is configured and controlled via two sets of registers. One in the PCI
configuration space and another set mapped in system address space. Since the
IOMMU appears to OS as a PCI function, it has a capability block in the PCI
configuration space. Additionally, up to eight data structures are placed in the
main system memory. These data structures contain information about the mapping
of interrupts and memory for the usage of peripheral devices. Information about
the device's memory access permissions is stored there too.

## Summary

IOMMU is a useful device with many advantages. Among other things, It protects a
system from DMA attacks and allows better isolation of virtual machines. Its main
disadvantage is the latency of DMA transfers due to the need to check mapping and
permission saved in main memory when the transfer occurs, but this latency can be
largely alleviated by caching that information inside IOMMU. In summary, the use
of IOMMU seems to be beneficial in almost every case.

If you think we can help in improving the security of your firmware or you
looking for someone who can boost your product by leveraging advanced features
of used hardware platform, feel free to [book a call with us](https://calendly.com/3mdeb/consulting-remote-meeting)
or drop us email to `contact<at>3mdeb<dot>com`. If you are interested in similar
content feel free to [sign up to our newsletter](http://eepurl.com/doF8GX)
