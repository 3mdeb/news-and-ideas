---
title: Boot Guard - pre-execution firmware verification
abstract: 'This post will not describe how to guard your shoes. However,
          will definitely introduce you to Boot Guard feature present on
          Intel processors which allows firmware verification before the first
          instruction executes. One may call it pre-execution firmware
          verification.'
cover: /covers/boot_guard.png
author: michal.zygowski
layout: post
published: true
date: 2020-02-18
archives: "2020"

tags:
  - Boot Guard
  - Secure Boot
  - coreboot
  - Protectli
categories:
  - Firmware
  - Security


---
### What Boot Guard is?

For sure, Boot Guard does not mean exactly what its name suggest, it is not
protecting shoes. In firmware and BIOS nomenclature `boot` means the bootstrap
process, which is the early processor initialization routine. Almost every
modern machine or processor has some kind of firmware which is responsible for
the bootstrap process - booting - which prepares the silicon to load the target
application or operating system. So Boot Guard means that it protects the boot
process and the firmware. But from what should it protect and why? You can find
it out by spending few spare minutes and reading this post.

---
### Why Boot Guard?

Nowadays security researchers are very focused on trustful solutions, security
technologies and low-level safety of the computer machines used everyday. They
explore every possibility and attack vector to find vulnerabilities in the most
crucial parts of security in modern systems, like: Intel ME, UEFI etc. By
exposing discovered threats the silicon vendors release fixes to protect the
hardware and software from being compromised.

How do you know that software you use is trustful, secure and hasn't been
maliciously modified before execution? One can only ensure that by establishing
the Root of Trust (ROT) as early as possible. There are 2 main type of ROTs:

- SRTM - Static Root of Trust for Measurement
- DRTM - Dynamic Root of Trust for Measurement

I will not explain the measurement process as it is not a part of this post.
What I will focus on is cryptographical verification in the ROT. ROT is the
beginning of the verification process, it is considered to be trusted and
verifies all components executed by firmware.

> For more details about ROT refer to [NIST](https://csrc.nist.gov/Projects/Hardware-Roots-of-Trust).

The trust and security will be as strong as good is the protection of ROT. One
may achieve it by locking SPI flash containing the firmware for example,
however it does not protect from SPI desoldering attack. New SPI can contain
maliciously modified firmware which compromises Root of Trust and may even
install some backdoors, keyloggers etc. In order to protect ourselves (and our
machines) from it we may use Boot Guard.

---
### How Boot Guard works?

Intel Boot Guard is a feature that allows firmware verification before the
first instructions gets executed. How was it achieved? This feature is
supported by Intel ME, which instructs the processor to load an Authenticated
Code Module (ACM) signed by Intel and validate the firmware (in short). During
the verification process is utilizes the Key Manifest, Boot Policy Manifest
(which are a part of Boot Guard feature) and the Firmware Interface Table
(FIT). Processor before fetching the first firmware instructions searches for
the FIT and applies microcode updates which are pointed by FIT. The microcode
verifies the ACM, which verifies the Key Manifest, which verifies Boot Policy
Manifest (so complicated right?). In the end the Boot Policy Manifest contains
the hashes and signatures of the code regions in firmware that have to be
protected and verified. After the firmware verification, ACM allows the
processor to fetch first instructions to be executed. So despite the firmware
is maliciously modified, it cannot execute if firmware verification fails.
Because the manifests that hold one's signing keys are validated before
firmware can execute. Furthermore the public key hash of the public key from
Key Manifest can be burned into hardware fuses and locked permanently to ensure
nobody expect the main key owner can approve a firmware signing key used to
sign Boot Policy Manifest.

The flow I have describe is one of the most restrictive profiles that Boot
Guard offers - strict verification without remediation. There are less
restrictive profile which allow the platform to keep running for 30 minutes if
firmware verification fails in order to restore system and flash trusted
firmware. But the production behavior of Boot Guard ensures that unverified
firmware cannot execute on the processor and immediately shutdowns the
platform.

---
### Where can I get Boot Guard for my platform?

One has to either pay thousands of $ to some big firmware development companies
to enable Boot Guard on your hardware or buy a high end machine which has Boot
Guard enabled.

That was true up till recently, where one of our customers -
[Protectli](https://protectli.com/) - asked us to improve the security of his
products called Vault with Boot Guard. Protectli sells compact network
appliance devices running Intel processors. The most powerful of them have
Intel 7th generation processors which are Boot Guard capable. As a matter of
fact that 3mdeb did coreboot port for those platforms to coreboot, it was even
easier to experiment with Boot Guard. And finally we have succeed. First
official platform running open-source firmware that has Boot Guard enabled is
here. It was possible thanks to the fact that Protectli cares about freedom and
see value in open-source firmware and software.

One will be able to witness these results at our booth at Embedded World
2020, but now I will give a small foretaste what awaits those interested at
Embedded World 2020 exhibition.

---
### Boot Guard and coreboot? Yes, of course.

The below asciinema cast presents the FW6B platform by Protectli booted with
Boot Guard enabled coreboot firmware executing an Intel tool called `MEInfo`
used to dump information about system and Management Engine.

[![asciicast](https://asciinema.org/a/InShgUHnP389ERobESFG6BYxf.svg)](https://asciinema.org/a/InShgUHnP389ERobESFG6BYxf?speed=1)

On the cast one may see many interesting information, but those relevant to the
Boot Guard are as follows:

- `OEM Public Key Hash FPF                      Not set`
- `OEM Public Key Hash ME                       7E8E9BF4EF2E3AC831672D0049414081EA8D32C2E36B5D69457D4E3AA0B70517`
- `ACM SVN FPF                                  0x2`
- `KM SVN FPF                                   0x0`

The `OEM Public Key Hash` represents the SHA256 of the key used to verify Key
Manifest. It is located in ME and on production devices burned into FPF (Field
Programmable Fuses).

`ACM SVN FPF` field describes the ACM security version, `0x2` means it is a
production ACM.

`KM SVN FPF` is a Key Manifest security version. It is used to revoke Key
Manifests. `0x0` means that no Key Manifest was revoked yet.

There are also few variables stored in ME:
```
                                             FPF                      ME
                                             ---                      --
Force Boot Guard ACM                         Not set                  Disabled
Protect BIOS Environment                     Not set                  Enabled
CPU Debugging                                Not set                  Enabled
BSP Initialization                           Not set                  Enabled
Measured Boot                                Not set                  Disabled
Verified Boot                                Not set                  Enabled
Key Manifest ID                              Not set                  0xF
Enforcement Policy                           Not set                  0x1
PTT                                          Not set                  Enabled
```

`Force Boot Guard ACM`, `Measured Boot`, `Verified Boot` and `Enforcement
Policy` make up the Boot Guard profile.

They can be encoded as follows:

Firmware verification with Boot Guard is enabled, `Enforcement Policy` equal to
1 means "allow remediation", system will shutdown after 30 minutes if firmware
verification fails. Disabled `Force Boot Guard ACM` means that if ACM is not
found on firmware, the processor will execute the code from reset vector. If
enabled the system will shutdown with delay based on `Enforcement Policy`. It
must be noted that not all combinations of these fields are allowed. Only
strictly defined Boot Guard profile determine these fields' values.

Other interesting values are `CPU Debugging` and `BSP Initialization` which
additionally protect the boot flow from modification via DCI or INIT signal.

This is only the status of variables. However the status of Boot Guard
successful firmware verification lies in the status registers:

- `FW Status Register4: 0x00084000`, bit 14 equal to one indicates that the
  information contained in this register is valid. Bit 9 which is zero
  indicates that the enforcement has not been triggered

- `FW Status Register5: 0x00000B01`, bit 31 is equal to zero, which means the
  chipset does not start enforcement logic. Bit 0 is equal to one and indicates
  that ACM is active (and of course present in firmware).

That means the system will not shutdown after 30 minutes as the Boot Guard
profile instructs the processor (if verification fails). Summing it up:

**Boot Guard verified the firmware successfully.**

## Summary

This is just a grasp of what Boot Guard can do. The presented information and
demonstration show non-production settings. The ME is still in Manufacturing
Mode which allows to reprogram the settings. It has been intentionally left
enabled for further development.

I encourage you to visit 3mdeb booth at Embedded World 2020 (25th - 27th of
February 2020 in Nuremberg, Germany). There you will be bale to see the Boot
Guard live. We will be at **hall 4 - 666**.

If you think we can help in improving the security of your firmware or you
looking for someone who can boost your product by leveraging advanced features
of used hardware platform, feel free to [book a call with us](https://calendly.com/3mdeb/consulting-remote-meeting)
or drop us email to `contact<at>3mdeb<dot>com`. If you are interested in similar
content feel free to [sing up to our newsletter](http://eepurl.com/gfoekD)
