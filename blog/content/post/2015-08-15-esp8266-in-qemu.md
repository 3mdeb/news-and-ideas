---
layout: post
title: "ESP8266 in Qemu"
date: 2015-08-15 14:58:54 +0200
comments: true
categories: ESP8266,QEMU
---

Why anyone would like to emulate $2 chip in Qemu ? There couple of reasons
that quick came to my mind. First is reverse engineering of binary part of SDK
and understand how this chip exactly works. Second is simplified application
testing and debugging. To fulfill those needs Qemu implementation of esp8266
have to be made. Thanks to community effort (especially
[jcmvbkbc](https://github.com/jcmvbkbc)) we have great foundation to start
with. Discussion about Qemu support for esp8266 can be found
[here](http://www.esp8266.com/viewtopic.php?f=9&t=26).

If you wish to dig even deeper and close to hardware of famous WiFi chip there is
ongoing support in OpenOCD for Xtensa core about which you can read
[here](http://www.esp8266.com/viewtopic.php?f=9&t=1871).

Both posts on esp form got similar attention of about 3-4k views, so I think
there is audience for this type of content.

## Quick setup steps

This is section was based on jcmvbkbc [video](http://jcmvbkbc.spb.ru/~dumb/tmp/qemu-system-xtensa-build-for-esp8266.ogv).

###Toolchain build

```
git clone git@github.com:pfalcon/esp-open-sdk.git
cd esp-open-sdk
make
```

###qemu-xtensa build

```
git clone git@github.com:OSLL/qemu-xtensa.git
cd qemu-xtensa
./confgiure --target-list=xtensa-softmmu
make
```

### Let's try to boot

```
xtensa-softmmu/qemu-system-xtensa -M esp8266 -nographic -serial stdio -monitor none
```

Serial log should look like this:
```
U0TXD: [SPICS1 -> U0TXD]
GPIO2: [GPIO2 -> U0TXD]
esp8266_rtc_write: +0x08: 00000000

 ets Jan  8 2013,rst cause:4, boot mode:(3,7)

wdt reset
SD_CLK: [SPI_CLK -> SD_CLK]
SD_CLK: [SD_CLK -> SPI_CLK]
SD_DATA0: [SPIQ -> SD_DATA0]
SD_DATA0: [SD_DATA0 -> SPIQ]
SD_DATA1: [SPID -> SD_DATA1]
SD_DATA1: [SD_DATA1 -> SPID]
SD_DATA2: [SPIHD -> SD_DATA2]
SD_DATA2: [SD_DATA2 -> SPIHD]
SD_DATA3: [SPIWP -> SD_DATA3]
SD_DATA3: [SD_DATA3 -> SPIWP]
SD_CMD: [pullup: 1 -> 0]
SD_CMD: [SD_CMD -> SPICS0]
unassigned: write +0x00000d48 = 00000000
esp8266_spi_read: +0x1c: 0x00000000
esp8266_spi_write: +0x1c = 0x00000004
esp8266_spi_read: +0x08: 0x00000000
esp8266_spi_write: +0x08 = 0x00000000
esp8266_spi_write: +0x08 = 0x00288313
esp8266_spi_write: +0x00 = 0x00100000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x08: 0x00288313
esp8266_spi_write: +0x08 = 0x00288313
esp8266_spi_read: +0x08: 0x00288313
esp8266_spi_write: +0x08 = 0x00688313
esp8266_dport_read: +0x0c: 0x00000000
esp8266_spi_write: +0x10 = 0x00000000
esp8266_spi_write: +0x00 = 0x08000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x10: 0x00000000
esp8266_spi_write: +0x00 = 0x40000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_write: +0x10 = 0x00000000
esp8266_spi_write: +0x00 = 0x08000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x10: 0x00000002
esp8266_spi_write: +0x10 = 0x00000000
esp8266_spi_write: +0x00 = 0x08000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x10: 0x00000002
esp8266_dport_read: +0x0c: 0x00000000
esp8266_spi_write: +0x10 = 0x00000000
esp8266_spi_write: +0x00 = 0x08000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x10: 0x00000002
esp8266_spi_write: +0x10 = 0x00000002
esp8266_spi_write: +0x00 = 0x04000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x08: 0x00688313
esp8266_spi_write: +0x08 = 0x00688313
esp8266_dport_read: +0x0c: 0x00000000
esp8266_spi_write: +0x10 = 0x00000000
esp8266_spi_write: +0x00 = 0x08000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x10: 0x00000002
esp8266_spi_write: +0x04 = 0x10000000
esp8266_spi_write: +0x00 = 0x80000000
esp8266_spi_cmd: READ FLASH 0x10@0x00000000
esp8266_spi_read: +0x00: 0x00000000
esp8266_spi_read: +0x40: 0x00000000
esp8266_spi_read: +0x44: 0x00000000
esp8266_spi_read: +0x48: 0x00000000
esp8266_spi_read: +0x4c: 0x00000000
ets_main.c
```
